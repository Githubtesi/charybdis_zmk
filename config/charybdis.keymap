#include <dt-bindings/zmk/mouse.h>
#include <behaviors/mouse_keys.dtsi>
#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/pointing.h>

/ {
    /* --- トラックボール入力設定 --- */

    trackball_listener {
        compatible = "zmk,input-behavior-listener";
        device = <&vtrackball>;
        status = "okay";

        /* 根拠: 0,1,2の全レイヤーでマウス移動を許可する */

        layers = <0 1 2 3 4 5 6 7>; // <-- ここを修正
        evt-type = <INPUT_EV_REL>;
        x-input-code = <INPUT_REL_X>;
        y-input-code = <INPUT_REL_Y>;
        scale-multiplier = <1>;
        scale-divisor = <4>;
    };

    /* --- レイヤー3専用：低速設定（DPI変更） --- */
    /* ----------
    trackball_snipe_listener {
        compatible = "zmk,input-behavior-listener";
        device = <&vtrackball>;
        status = "okay";

        // 下記レイヤーの時だけこの設定を適用する

        layers = <2 3>;
        evt-type = <INPUT_EV_REL>;
        x-input-code = <INPUT_REL_X>;
        y-input-code = <INPUT_REL_Y>;
        scale-multiplier = <1>;

        // 根拠: 分母を大きくすると、マウスはより精密（低速）に動きます

        scale-divisor = <16>; // 2から8に変えることで、通常より4倍遅くなります
    };


    trackball_scroll_listener {
        compatible = "zmk,input-behavior-listener";
        device = <&vtrackball>;
        layers = <9>;
        evt-type = <INPUT_EV_REL>;
        x-input-code = <INPUT_REL_MISC>;
        y-input-code = <INPUT_REL_WHEEL>;
        y-invert;
        bindings = <&ib_wheel_scaler 1 14>;
    };

    --------- */

    ib_wheel_scaler: ib_wheel_scaler {
        compatible = "zmk,input-behavior-scaler";
        #binding-cells = <2>;
        evt-type = <INPUT_EV_REL>;
        input-code = <INPUT_REL_WHEEL>;
    };

    /* --- コンボ設定 --- */

    combos {
        compatible = "zmk,combos";

        zenkaku-hankaku-toggle {
            bindings = <&kp GRAVE>;
            key-positions = <14 13>;
            timeout-ms = <60>;
            require-prior-idle-ms = <100>;
            layers = <1 3 2 0>;
            slow-release;
        };

        voice_input {
            bindings = <&kp LC(ENTER)>;
            key-positions = <36 37>;
            layers = <0 2 1 3 7>;
        };
    };

    /* --- 特殊挙動定義 (エラー解消の根拠) --- */

    behaviors {
        auto_shift: auto_shift {
            compatible = "zmk,behavior-hold-tap";
            label = "AUTO_SHIFT";
            #binding-cells = <2>;
            flavor = "tap-preferred";
            tapping-term-ms = <280>;
            quick-tap-ms = <175>;
            bindings = <&kp>, <&kp>;
        };

        hmr: hmr {
            compatible = "zmk,behavior-hold-tap";
            label = "HMR";
            #binding-cells = <2>;
            tapping-term-ms = <190>;
            quick-tap-ms = <175>;
            flavor = "balanced";
            bindings = <&kp>, <&kp>;

            hold-trigger-key-positions = <0 1 2 3 4 5 12 13 14 15 16 17 24 25 26 27 28 29 36 37 38 39 40 41 48 49 50 51 52 53 54 55>;
        };

        hml: hml {
            compatible = "zmk,behavior-hold-tap";
            label = "HML";
            #binding-cells = <2>;
            tapping-term-ms = <190>;
            quick-tap-ms = <175>;
            flavor = "balanced";
            bindings = <&kp>, <&kp>;

            hold-trigger-key-positions = <6 7 8 9 10 11 18 19 20 21 22 23 30 31 32 33 34 35 42 43 44 45 46 47 48 49 50 51 52 53 54 55>;
        };
    };

    /* --- キーマップ --- */

    keymap {
        compatible = "zmk,keymap";

        norman {
            bindings = <
&kp ESC                  &auto_shift EXCLAMATION N1  &auto_shift AT_SIGN N2    &auto_shift POUND N3  &auto_shift DOLLAR N4  &auto_shift PERCENT N5      &auto_shift CARET N6  &auto_shift AMPERSAND N7  &auto_shift KP_ASTERISK N8  &auto_shift LEFT_PARENTHESIS N9  &auto_shift RIGHT_PARENTHESIS N0     &auto_shift LEFT_BRACE LEFT_BRACKET
&kp TAB                  &kp Q                       &kp W                     &kp D                 &kp F                  &kp K                       &kp J                 &kp U                     &kp R                       &kp L                            &auto_shift LS(SEMICOLON) SEMICOLON  &auto_shift RIGHT_BRACE RIGHT_BRACKET
&kp LALT                 &auto_shift RCTRL A         &auto_shift LEFT_SHIFT S  &kp E                 &kp T                  &auto_shift UNDERSCORE G    &kp Y                 &kp N                     &kp I                       &auto_shift RIGHT_SHIFT O        &auto_shift LCTRL H                  &auto_shift RS(SQT) SQT
&auto_shift UNDER MINUS  &kp Z                       &kp X                     &kp C                 &kp V                  &kp B                       &kp P                 &kp M                     &auto_shift LT COMMA        &auto_shift GREATER_THAN DOT     &auto_shift LS(SLASH) SLASH          &auto_shift LS(EQUAL) EQUAL
                                                                               &mo 4                 &to 3                  &to 2                       &to 1                 &mo 7
                                                                                                     &kp BACKSPACE          &kp SPACE                   &to 0
            >;

            label = "英語配列";
        };

        onisi {
            label = "大西配列";
            bindings = <
&kp ESCAPE    &kp N1               &kp N2                    &kp N3  &kp N4         &kp N5                          &kp N6  &kp N7  &kp N8  &kp N9                     &kp N0               &kp SLASH
&kp TAB       &kp Q                &kp L                     &kp U   &kp COMMA      &kp DOT                         &kp F   &kp W   &kp R   &kp Y                      &kp P                &kp BSLH
&kp LEFT_ALT  &auto_shift LCTRL E  &auto_shift LEFT_SHIFT I  &kp A   &kp O          &auto_shift UNDERSCORE MINUS    &kp K   &kp T   &kp N   &auto_shift RIGHT_SHIFT S  &auto_shift RCTRL H  &kp RIGHT_ALT
&none         &kp Z                &kp X                     &kp C   &kp V          &kp SEMI                        &kp G   &kp D   &kp M   &kp J                      &kp B                &none
                                                             &mo 4   &to 3          &to 2                           &to 1   &mo 7
                                                                     &kp BACKSPACE  &kp SPACE                       &to 0
            >;
        };

        mouse {
            label = "マウス移動";
            bindings = <
&kp ESC       &none      &kp F2          &none      &none                        &none        &none     &kp RC(KP_MINUS)  &none           &kp RC(KP_PLUS)  &none       &none
&kp TAB       &none      &none           &none      &none                        &none        &none     &kp PAGE_DOWN     &kp UP_ARROW    &kp PAGE_UP      &kp DELETE  &none
&kp LEFT_ALT  &kp LCTRL  &kp LEFT_SHIFT  &kp LC(A)  &auto_shift LC(LS(F)) LC(F)  &none        &none     &kp LEFT          &kp DOWN_ARROW  &kp RIGHT_ARROW  &none       &none
&none         &kp LC(Z)  &kp RC(X)       &kp LC(C)  &auto_shift LG(V) RC(V)      &none        &mkp MB4  &mkp LCLK         &mkp MCLK       &mkp RCLK        &mkp MB5    &none
                                         &mo 4      &to 3                        &none        &to 1     &mo 7
                                                    &kp BACKSPACE                &kp ENTER    &to 0
            >;
        };

        number {
            bindings = <
&kp ESC  &none  &none  &none  &none          &none        &kp GRAVE        &kp KP_PLUS      &kp KP_MINUS     &kp KP_ASTERISK  &kp KP_SLASH  &none
&none    &none  &none  &none  &none          &none        &none            &kp KP_NUMBER_7  &kp KP_NUMBER_8  &kp KP_NUMBER_9  &none         &none
&none    &none  &none  &none  &none          &none        &kp EQUAL        &kp KP_NUMBER_4  &kp KP_NUMBER_5  &kp KP_NUMBER_6  &none         &kp KP_ENTER
&none    &none  &none  &none  &none          &none        &kp KP_NUMBER_0  &kp KP_NUMBER_1  &kp KP_NUMBER_2  &kp KP_NUMBER_3  &kp DOT       &none
                       &mo 4  &none          &to 2        &to 1            &mo 7
                              &kp BACKSPACE  &kp SPACE    &to 0
            >;

            label = "テンキー";
        };

        other_base {
            bindings = <
&none  &none  &none  &none  &none  &none    &none  &none  &none  &none  &none  &none
&none  &none  &none  &none  &none  &none    &none  &none  &none  &none  &to 6  &none
&none  &to 5  &none  &none  &none  &none    &none  &none  &none  &none  &none  &none
&none  &none  &none  &none  &none  &none    &none  &none  &none  &none  &none  &none
                     &none  &none  &none    &none  &none
                            &none  &none    &none
            >;

            label = "ベース(アプリ)";
        };

        Excel {
            bindings = <
&none  &none  &none  &none  &none  &none    &none  &none  &none  &none  &none  &none
&none  &none  &none  &none  &none  &none    &none  &none  &none  &none  &none  &none
&none  &none  &none  &none  &none  &none    &none  &none  &none  &none  &none  &none
&none  &none  &none  &none  &none  &none    &none  &none  &none  &none  &none  &none
                     &mo 4  &to 3  &to 2    &to 1  &mo 7
                            &none  &none    &to 0
            >;

            label = "エクセルコマンド";
        };

        pycharm_command {
            bindings = <
&none  &none                        &none                             &none      &none                        &none                          &kp LS(F6)  &none  &none  &none  &none          &auto_shift LS(F11) F11
&none  &none                        &kp LC(W)                         &kp LC(E)  &auto_shift LC(LS(R)) LC(R)  &none                          &none       &none  &none  &none  &none          &none
&none  &auto_shift LCTRL LS(LC(A))  &auto_shift LEFT_SHIFT LA(LC(S))  &kp LC(D)  &auto_shift LS(LC(F)) LC(F)  &none                          &none       &none  &none  &none  &none          &none
&none  &kp LC(Z)                    &kp LC(X)                         &kp LC(C)  &auto_shift LC(LS(V)) LC(V)  &auto_shift LA(LC(B)) LC(B)    &none       &none  &none  &none  &kp LC(SLASH)  &none
                                                                      &mo 4      &to 3                        &to 2                          &to 1       &mo 7
                                                                                 &none                        &none                          &to 0
            >;

            label = "pycharmコマンド";
        };

        edit {
            label = "文字入力確定";
            bindings = <
&none         &none      &none           &none      &none                        &none        &none  &none           &none           &none            &none    &none
&kp TAB       &none      &none           &none      &none                        &none        &none  &kp PAGE_DOWN   &kp UP          &kp PAGE_UP      &kp DEL  &none
&kp LEFT_ALT  &kp LCTRL  &kp LEFT_SHIFT  &kp LC(A)  &auto_shift LC(LS(F)) LC(F)  &none        &none  &kp LEFT_ARROW  &kp DOWN_ARROW  &kp RIGHT_ARROW  &none    &none
&none         &kp LC(Z)  &kp LC(X)       &kp LC(C)  &auto_shift LG(V) LC(V)      &none        &none  &mkp LCLK       &none           &none            &none    &none
                                         &none      &none                        &none        &none  &none
                                                    &kp BACKSPACE                &kp ENTER    &none
            >;
        };

        qwerty {
            bindings = <
&kp GRAVE  &kp N1  &kp N2  &kp N3  &kp N4  &kp N5    &kp N6  &kp N7  &kp N8     &kp N9   &kp N0    &kp MINUS
&kp TAB    &kp Q   &kp W   &kp E   &kp R   &kp T     &kp Y   &kp U   &kp I      &kp O    &kp P     &kp AT
&kp CAPS   &kp A   &kp S   &kp D   &kp F   &kp G     &kp H   &kp J   &kp K      &kp L    &kp SEMI  &kp APOS
&kp LSHFT  &kp Z   &kp X   &kp C   &kp V   &kp B     &kp N   &kp M   &kp COMMA  &kp DOT  &kp FSLH  &kp RSHFT
                           &trans  &trans  &trans    &trans  &trans
                                   &trans  &trans    &trans
            >;

            label = "テスト用_ダミー";
        };
    };
};
